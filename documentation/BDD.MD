# BDD.md

Description de la **structure PocketBase** utilis√©e par l‚Äôapp.  
Les contraintes d‚Äôacc√®s (rules) et le protocole crypto sont d√©taill√©s dans `SECURITY.md`.  
Le contrat UI/Backend par module est d√©taill√© dans `MODULES.md`.

---

## 0) Conventions

- Toutes les tables d‚Äôentr√©es suivent le sch√©ma commun :  
  `module_user_id` (cl√© secondaire), `payload` (chiffr√©), `cipher_iv`, `guard` (hidden), `created`, `updated`.
- `guard` est **hidden** et **requis**. Il est **d√©riv√© par HMAC** c√¥t√© client puis **stock√©**.  
  Cr√©ation en **2 temps** : `POST guard="init"` ‚Üí **PATCH de promotion** (voir `SECURITY.md`).
- Pr√©fixes d‚Äôidentifiants secondaires : `m_‚Ä¶` (Mood), `g_‚Ä¶` (Goals), etc.

---

## 1) `users` (auth)

- **Type**: `auth`  
- **Acc√®s**: `list/view/update/delete` autoris√©s pour l‚Äô`id` courant ou r√¥le `admin`.

| Champ              | Type     | Requis | Hidden | Contraintes / Notes                                            |
|--------------------|----------|--------|--------|----------------------------------------------------------------|
| `id`               | text PK  | yes    | no     | G√©n√©r√© PB (`[a-z0-9]{15}`)                                     |
| `username`         | text     | yes    | no     |                                                                |
| `email`            | email    | yes    | no     | syst√®me PB                                                     |
| `verified`         | bool     | no     | no     | syst√®me PB                                                     |
| `role`             | select   | no     | no     | `admin` \| `user`                                              |
| `encrypted_key`    | text     | yes    | no     | **blob chiffr√©** (scell√© avec la cl√© d√©riv√©e du mot de passe) |
| `encryption_salt`  | text     | yes    | no     | sel pour Argon2id                                              |
| `modules`          | text     | no     | no     | **blob chiffr√©**: √©tat des modules (enabled, module_user_id)  |
| `created`          | autodate | auto   | no     |                                                                |
| `updated`          | autodate | auto   | no     |                                                                |

**Indexes principaux**
- uniques PB par d√©faut (`email`, `tokenKey`).

---

## 2) `invites_codes`

- **Type**: `base`  
- **Acc√®s**: cr√©ation par `admin`, lecture publique (via `viewRule` existante).

| Champ     | Type     | Requis | Hidden | Notes         |
|-----------|----------|--------|--------|---------------|
| `id`      | text PK  | yes    | no     | PB            |
| `code`    | text     | yes    | no     |               |
| `created` | autodate | auto   | no     |               |
| `updated` | autodate | auto   | no     |               |

---

## 3) `mood_entries`

- **Type**: `base`  
- **Acc√®s** (r√®gles c√¥t√© PB) :  
  - `list/view` : `record.module_user_id = @request.query.sid`  
  - `update/delete` : idem **et** `record.guard = @request.query.d`

| Champ            | Type     | Requis | Hidden | Contraintes / Notes                                                                                                   |
|------------------|----------|--------|--------|-----------------------------------------------------------------------------------------------------------------------|
| `id`             | text PK  | yes    | no     | PB                                                                                                                    |
| `module_user_id` | text     | yes    | no     | `^[a-z0-9_\\-]{16,}$` (id secondaire opaque, ex. `m_‚Ä¶`)                                                               |
| `payload`        | text     | yes    | no     | **Base64URL** d‚Äôun blob **AES-GCM**                                                                                   |
| `cipher_iv`      | text     | yes    | no     | **Base64URL** (IV AES-GCM)                                                                                            |
| `guard`          | text     | yes    | **yes**| **Hidden**. Pattern **`^(g_[a-z0-9]{32,}|init)$`**. Cr√©ation en 2 temps : POST `"init"` ‚Üí PATCH de promotion (HMAC). |
| `created`        | autodate | auto   | no     |                                                                                                                       |
| `updated`        | autodate | auto   | no     |                                                                                                                       |

**Index**
- `CREATE INDEX idx_mood_entries_sid ON mood_entries(module_user_id);`

**Payload clair attendu (r√©f√©rence)**  
_Stock√© chiffr√© dans `payload` (voir `MODULES.md` pour le contrat exact)._
json
{
  "date": "YYYY-MM-DD",
  "mood_score": "<-2..+2|string|number>",
  "mood_emoji": "üôÇ",
  "positive1": "string",
  "positive2": "string",
  "positive3": "string",
  "comment": "string|optional",
  "question": "string|optional",
  "answer": "string|optional"
}
`

---

## 4) `goals_entries`

* **Type**: `base`
* **Acc√®s** (r√®gles PB) : identiques √† `mood_entries`.

| Champ            | Type     | Requis | Hidden  | Contraintes / Notes                                     |                                                                               |
| ---------------- | -------- | ------ | ------- | ------------------------------------------------------- | ----------------------------------------------------------------------------- |
| `id`             | text PK  | yes    | no      | PB                                                      |                                                                               |
| `module_user_id` | text     | yes    | no      | `^[a-z0-9_\\-]{16,}$` (id secondaire opaque, ex. `g_‚Ä¶`) |                                                                               |
| `payload`        | text     | yes    | no      | **Base64URL** d‚Äôun blob **AES-GCM**                     |                                                                               |
| `cipher_iv`      | text     | yes    | no      | **Base64URL** (IV AES-GCM)                              |                                                                               |
| `guard`          | text     | yes    | **yes** | **Hidden**. Pattern \*\*\`^(g\_\[a-z0-9]{32,}           | init)\$`**. Cr√©ation en 2 temps : POST `"init"\` ‚Üí PATCH de promotion (HMAC). |
| `created`        | autodate | auto   | no      |                                                         |                                                                               |
| `updated`        | autodate | auto   | no      |                                                         |                                                                               |

**Index**

* `CREATE INDEX idx_goals_entries_sid ON goals_entries(module_user_id);`

**Payload clair attendu (r√©f√©rence)**

json
{
  "date": "YYYY-MM-DD",
  "title": "string",
  "note": "string|optional",
  "status": "open|done|wip"
}


---

## 5) Notes g√©n√©rales

* **Hidden** : les champs `guard` n‚Äôapparaissent **jamais** dans les r√©ponses API.
* **Cr√©ation en 2 temps** :

  * POST avec `guard="init"` (le hook serveur recopie la valeur dans le champ hidden),
  * PATCH de promotion avec `?sid=<module_user_id>&d=init` pour √©crire la valeur HMAC finale.
* **Update/Delete** : n√©cessitent `?sid=<module_user_id>&d=<guard>` (√©galit√© stricte c√¥t√© PB).
* **Aucune donn√©e en clair** n‚Äôest stock√©e : seul `payload` (chiffr√©) + `cipher_iv` sont persist√©s.
* **Export JSON (r√©f√©rence)**
- Le fichier d‚Äôexport regroupe les payloads clairs par module dans modules.<nomDuModule>[].
- Non inclus : payload (blob chiffr√©), cipher_iv, guard, id.
- Exemple de racine¬†:
``` json
{ "meta": { "version": 1, "exported_at": "<ISO8601Z>", "app": "Nodea" },
  "modules": { "mood": [ ‚Ä¶ ], "goals": [ ‚Ä¶ ] } }
```
- L‚Äôimport utilise le flux create en 2 temps d√©crit dans SECURITY.md (promotion HMAC).

---

## 6) √âvolution / Migration

* Passage depuis l‚Äôancien mod√®le (guard al√©atoire stock√© c√¥t√© client) :

  * Mettre √† jour le **pattern** de `guard` en `^(g_[a-z0-9]{32,}|init)$`.
  * UI : impl√©menter la **promotion HMAC** (`POST init` ‚Üí `PATCH` HMAC).
  * Plus de stockage local du guard : recalcul √† la vol√©e via HMAC.
