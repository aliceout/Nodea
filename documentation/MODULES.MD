# MODULES.md

## üß© Syst√®me de modules dans Nodea

Chaque utilisateur¬∑rice peut activer ou d√©sactiver des modules ind√©pendants (Mood, Goals, Reviews, etc.), chacun stockant des donn√©es personnelles chiffr√©es. Ce document d√©crit la structure, la logique d‚Äôacc√®s, et les conventions li√©es √† ces modules.

## Quick‚Äëstart

1) Connexion ‚Üí d√©rive `mainKey` ‚Üí d√©chiffre `users.modules` ‚Üí hydrate `modulesState`.
2) Activer un module si besoin :
   - s‚Äôil n‚Äôa pas d‚Äô`id`, en g√©n√©rer un (`module_user_id`), `enabled: true`,
   - r√©encrypter `users.modules`, update serveur.
3) CRUD d‚Äôun module :
   - list/view : GET /<module>_entries?sid=<module_user_id>
   - create    : body { module_user_id, payload, cipher_iv, guard }
   - update/del: ‚Ä¶?sid=<module_user_id>&d=<guard>

---

## 1. Vue d'ensemble

- Chaque module est autonome (pas de d√©pendance entre eux).
- Les donn√©es sont chiffr√©es **c√¥t√© client**.
- L‚Äôacc√®s aux entr√©es d‚Äôun module se fait via un **identifiant secondaire unique (`module_user_id`)**, jamais li√© directement √† `user.id`.

---

## 2. Structure stock√©e dans `users.modules` (chiffr√©)

Le champ `modules` dans la table `users` contient une **structure JSON**, chiffr√©e avec la `mainKey`. Chaque module est identifi√© par son nom (`mood`, `goals`, etc.) :

```json
{
  "mood": {
    "enabled": true,
    "id": "m_abc123"
  },
  "goals": {
    "enabled": false,
    "id": "g_xyz789"
  }
}
````

* `enabled` : bool√©en indiquant si le module est activ√©.
* `id` : identifiant secondaire unique, utilis√© comme `module_user_id` dans les entr√©es.

---

## 3. Tables de donn√©es des modules

Chaque module a sa propre table PocketBase (ex : `mood_entries`, `goals_entries`) avec les caract√©ristiques suivantes :

* Champs sensibles (`payload`, `cipher_iv`, `guard`) g√©n√©r√©s c√¥t√© client.
* Le champ en clair de jointure est `module_user_id`.
* Pas de relation avec `user.id`.

Exemple d‚Äôentr√©e :

```json
{
  "id": "rec_xyz",
  "module_user_id": "m_abc123",
  "payload": "<blob chiffr√©>",
  "cipher_iv": "<IV utilis√©>",
  "guard": "g_a1b2c3d4e5f6",
  "created": "...",
  "updated": "..."
}
```

---

## 4. Activation d‚Äôun module

1. L‚Äôutilisateur¬∑rice active le module (via Settings).
2. Si l‚Äôentr√©e `modules[m]` n‚Äôexiste pas encore :

   * G√©n√©rer un `module_user_id` unique
   * D√©finir `enabled: true`
3. R√©encrypter le champ `modules` avec la `mainKey`
4. Mettre √† jour `users.modules` c√¥t√© serveur

---

## 5. Chargement √† la connexion

1. Le client r√©cup√®re `users.modules` (chiffr√©)
2. Le d√©chiffre avec la `mainKey`
3. Stocke le r√©sultat dans un store (`modulesState`)
4. Les composants utilisent ce store pour :

   * savoir si un module est activ√©
   * obtenir le `module_user_id`
   * charger les entr√©es (`GET /mood_entries?sid=<module_user_id>`)

---

## 6. Acc√®s aux donn√©es

* **Lecture** : `GET /<module>_entries?sid=<module_user_id>`
* **Cr√©ation** : body `{ module_user_id, payload, cipher_iv, guard }`
* **Update/Delete** : `PATCH|DELETE ‚Ä¶?sid=<module_user_id>&d=<guard>` (guard requis)

---

## 7. D√©sactivation d‚Äôun module

* La d√©sactivation **ne supprime pas** les donn√©es ni l‚Äô`id`.
* Le champ `enabled: false` masque le module dans l‚ÄôUI.
* Une r√©activation r√©utilise le m√™me `id`.

---

## 8. R√©sum√© des responsabilit√©s

| √âl√©ment              | R√¥le                                             |
| -------------------- | ------------------------------------------------ |
| `users.modules`      | Config chiffr√©e des modules                      |
| `module_user_id`     | Jeton opaque pour acc√©der aux donn√©es            |
| Tables de modules    | Stockage des entr√©es par `module_user_id`        |
| UI (client)          | Active/d√©sactive, g√©n√®re `id`, chiffre/d√©chiffre |
| Serveur (PocketBase) | Stocke les blobs, applique les r√®gles d‚Äôacc√®s    |

---

## 9. Ce qui n‚Äôest pas encore impl√©ment√©

* Rotation/r√©vocation d‚Äô`id`
* Liaisons entre modules
* Journalisation fine des actions
* R√®gles de s√©curit√© avanc√©es (caps time-based)

---

## 10. Glossaire rapide

* `module_user_id` : identifiant secondaire unique par module
* `payload` : contenu chiffr√©
* `guard` : secret requis pour update/delete
* `mainKey` : cl√© AES propre √† l‚Äôutilisateur¬∑rice

---

## 11. Convention de nommage

* Pr√©fixes d‚Äô`id` : `m_` pour Mood, `g_` pour Goals, etc.
* Tables PB : `<module>_entries`
* Stores frontend : `modulesState`
* Cl√©s JSON de `users.modules` = noms de modules dans le code

---

## 12. Validation & fallback c√¥t√© client

* Le module doit exister dans `users.modules`
* Il doit avoir `enabled: true`
* Il doit avoir un `id`

Sinon :

* Message d‚Äôerreur : `Module non configur√©`
* Ou bouton d‚Äôactivation (g√©n√®re un nouvel `id`)

----

## R√®gles d‚Äôacc√®s PB (r√©sum√©)

- list/view:
  request.query.sid != "" && record.module_user_id = request.query.sid

- update/delete:
  request.query.sid != "" && request.query.d != "" &&
  record.module_user_id = request.query.sid &&
  record.guard = request.query.d
